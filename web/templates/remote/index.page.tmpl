{{if .Data.IsStreamPage}}
  {{template "shared/stream-page.layout.tmpl" .}}
{{else}}
  {{template "shared/base.layout.tmpl" .}}
{{end}}

{{define "title"}}Remote Access{{end}}
{{define "description"}}Manage settings for remote access{{end}}

{{define "content"}}
  {{
    template "shared/turbo-cable-stream-source.partial.tmpl" dict
    "Name" (print .Meta.BasePath "remote")
    "BasePath" .Meta.BasePath
  }}

  <main class="main-container" tabindex="-1" data-controller="default-scrollable">
    {{if ne (.Meta.Form.Get "nav") "hidden"}}
      <nav class="breadcrumb main-breadcrumb" aria-label="breadcrumbs">
        <ul>
          <li><a href="{{urlJoin (dict
            "path" .Meta.BasePath
            "query" .Meta.Form.Encode
          )}}">Admin</a></li>
          <li class="is-active"><a href="{{urlJoin (dict
            "path" .Meta.Path
            "query" .Meta.Form.Encode
          )}}" aria-current="page">Remote</a></li>
        </ul>
      </nav>
    {{end}}

    <section class="section content">
      <h1>Remote Access</h1>
    </section>

    <section class="section content">
      {{$stateInfo := .Data.State.Info}}

      <div class="card section-card">
        <div class="card-content">
          {{$disconnected := or (eq .Data.NetworkName "") (eq $stateInfo.Short "stopped")}}
          <turbo-frame
            id="remote_assistance"
            data-turbo-reload
            refresh="morph"
          >
            <h2>Remote assistance</h2>
            {{if $disconnected}}
              <p>
                Enter the device authentication key given to you by the person helping you, so that
                they can remotely access your machine:
              </p>
              <form
                action="{{.Meta.BasePath}}remote/assistance"
                method="POST"
                class="is-inline-block mt-3"
                data-turbo-frame="_top"
                data-controller="form-submission"
                data-action="submit->form-submission#submit"
              >
                <input type="hidden" name="state" value="enabled">
                <input type="hidden" name="redirect-target" value="{{urlJoin (dict
                  "path" .Meta.Path
                  "query" .Meta.Form.Encode
                )}}">
                <div class="field">
                  <input
                    class="input" type="text"
                    name="device-authentication-key"
                    minlength=1
                    required
                    autocomplete="off"
                    size=30
                    data-controller="event"
                    data-action="turbo:before-morph-attribute->event#cancel"
                  >
                </div>
                <article class="message is-warning two-card-width">
                  <div class="message-body">
                    You should not use a device authentication key from anyone you don't fully trust!
                    They may have full access to everything on your machine.
                  </div>
                </article>
                <div class="field">
                  <div class="control" data-form-submission-target="submitter">
                    <input
                      class="button is-info"
                      type="submit"
                      value="Enable"
                      data-form-submission-target="submit"
                      placeholder="ts-key-auth-..."
                    >
                  </div>
                </div>
              </form>
            {{else}}
              <p>
                Remote assistance is allowed over the <strong>{{.Data.NetworkName}}</strong> network.
                To stop allowing remote access through that network, disable remote assistance:
              </p>
              <form
                action="{{.Meta.BasePath}}remote/assistance"
                method="POST"
                class="is-inline-block mt-3"
                data-turbo-frame="_top"
                data-controller="form-submission"
                data-action="submit->form-submission#submit"
              >
                <input type="hidden" name="state" value="disabled">
                <input type="hidden" name="redirect-target" value="{{urlJoin (dict
                  "path" .Meta.Path
                  "query" .Meta.Form.Encode
                )}}">
                <div class="field">
                  <div class="control" data-form-submission-target="submitter">
                    <input
                      class="button is-info"
                      type="submit"
                      value="Disable"
                      data-form-submission-target="submit"
                    >
                  </div>
                </div>
              </form>
            {{end}}
          </turbo-frame>
        </div>
      </div>
    </section>

    <section class="section content">
      <h2>Remote-access agent</h2>
      <p>
        The remote-access agent (Tailscale) makes your machine available for remote connections
        through a Tailscale mesh VPN.
      </p>

      <turbo-frame
        id="remote_tailscale"
        data-turbo-reload
        refresh="morph"
      >
        <p>
          Status:
          <span class="tag is-{{$stateInfo.Level}}">
            {{if $stateInfo.Details}}
              <abbr title="{{$stateInfo.Details}}">{{$stateInfo.Short}}</abbr>
            {{else}}
              {{$stateInfo.Short}}
            {{end}}
          </span>
        </p>

        <!--
          <p>
            TODO: add buttons to temporarily and persistently start/stop tailscaled.service!
            (if we've connected to the app using a ts.net DNS name, display a warning that stopping it
            will make the DNS name stop working for us)
          </p>
        -->

        <p>
          Connectivity:
          {{if .Data.Online}}
            <span class="tag is-success">
              connected
            </span>
          {{else}}
            <span class="tag is-warning">
              <abbr title="not connected to the remote-access network">disconnected</abbr>
            </span>
          {{end}}
        </p>

        <!--
          <p>TODO: add buttons to log out and log in to the tailnet</p>
        -->

        {{if not (eq .Data.NetworkName "")}}
          <p>
            <abbr title="the name of the remote-access network your machine has joined">Network</abbr>:
            {{.Data.NetworkName}}
          </p>
        {{end}}

        {{if not (eq .Data.DNSName "")}}
          <p>
            <abbr title="the DNS name of your machine within the remote-access network">
              Domain name
              {{- /* make template ignore the line break */ -}}
            </abbr>:
            <span class="tag domain-name">{{trimSuffix "." .Data.DNSName}}</span>
          </p>
        {{end}}

        <!-- We hide this info because it's on the tailscale web UI, and it's advanced info:
          {{if gt (len .Data.IPs) 0}}
            <p>
              <abbr title="the IP addresses of your machine within the remote-access network">
                IP addresses
                {{- /* make template ignore the line break */ -}}
              </abbr>:
              <ul>
                {{range $ipAddr := .Data.IPs}}
                  <li>
                    <span class="tag ip-address">{{$ipAddr}}</span>
                  </li>
                {{end}}
              </ul>
            </p>
          {{end}}
        --> 
        <p>
          You can view more information on this device's
          <a href="{{.Meta.BasePath}}remote/tailscale/details" target="_blank">Tailscale web UI</a>.
        </p>
      </turbo-frame>
    </section>
  </main>
{{end}}
