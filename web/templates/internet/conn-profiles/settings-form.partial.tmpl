{{$settings := (get . "Settings")}}
{{$Meta := (get . "Meta")}}

{{$conn := $settings.Conn}}

<form
  action="{{$Meta.BasePath}}internet/conn-profiles/{{$conn.UUID}}"
  method="POST"
  data-controller="form-submission"
  data-action="submit->form-submission#submit"
>
  <input type="hidden" name="state" value="updated">
  <input type="hidden" name="redirect-target" value="{{urlJoin (dict
    "path" $Meta.Path
    "query" $Meta.Form.Encode
  )}}">
  <div data-form-submission-target="submitter">
    <div class="field is-grouped">
      <div class="control">
        <input
          class="button is-primary"
          type="submit"
          name="update-type"
          value="Apply temporarily"
          data-form-submission-target="submit"
        >
      </div>
      <!--
        TODO: if the profile is auto-generated, disable this button and show a message
        explaining why it's disabled
      -->
      <div class="control">
        <input
          class="button is-primary"
          type="submit"
          name="update-type"
          value="Save and apply"
          data-form-submission-target="submit"
        >
      </div>
    </div>
  </div>

  <h3>Connection</h3>
  <turbo-frame
    id="internet_conn-profiles_{{$conn.UUID}}_connection.frame"
    data-turbo-reload
    refresh="morph"
  >
    <div class="field is-horizontal">
      <div class="field-label">
        <label class="label">
          ID
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            {{if $conn.ID}}
              {{$conn.ID}}
            {{else}}
              <span class="tag is-error">none</span>
            {{end}}
          </div>
        </div>
      </div>
    </div>

    <div class="field is-horizontal">
      <div class="field-label">
        <label class="label">
          UUID
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            {{if $conn.UUID.String}}
              {{$conn.UUID.String}}
            {{else}}
              <span class="tag is-error">none</span>
            {{end}}
          </div>
        </div>
      </div>
    </div>

    {{if $conn.StableID}}
      <div class="field is-horizontal">
        <div class="field-label">
          <label class="label">
            Stable ID
          </label>
        </div>
        <div class="field-body">
          <div class="field">
            <div class="control">
              {{$conn.StableID}}
            </div>
          </div>
        </div>
      </div>
    {{end}}

    <div class="field is-horizontal">
      <div class="field-label">
        <label class="label">
          Type
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            {{if $conn.Type}}
              {{if eq $conn.Type.Info.Short $conn.Type}}
                {{$conn.Type}}
              {{else}}
                <abbr title="{{$conn.Type}}">{{$conn.Type.Info.Short}}</abbr>
              {{end}}
            {{else}}
              <span class="tag is-error">none</span>
            {{end}}
          </div>
        </div>
      </div>
    </div>

    <div class="field is-horizontal">
      <div class="field-label">
        <label class="label">
          <abbr title="the network interface which this connection is allowed for">Device</abbr>
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            {{if $conn.InterfaceName}}
              <a href="{{(urlJoin (dict
                "path" (print $Meta.BasePath "internet")
                "query" $Meta.Form.Encode
                "fragment" (print "internet_devices_" $conn.InterfaceName ".card")
              ))}}" target="_top">
                {{$conn.InterfaceName}}
              </a>
            {{else}}
              <span class="tag is-info">any appropriate interface</span>
            {{end}}
          </div>
        </div>
      </div>
    </div>

    <div class="field is-horizontal">
      <div class="field-label">
        <label class="label">
          <abbr title="when the connection was last successfully fully activated">Last used</abbr>
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            {{if $conn.Timestamp.IsZero}}
              <span class="tag is-info">never, or unknown</span>
            {{else}}
              <abbr title="at {{dateInZone "2006-01-2 15:04 MST" $conn.Timestamp "UTC"}}">
                {{durationRound (ago $conn.Timestamp)}} ago
              </abbr>
            {{end}}
          </div>
        </div>
      </div>
    </div>

    <div class="field is-horizontal">
      <div class="field-label">
        <label class="label">
          <abbr title="firewall trust level">Zone</abbr>
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            {{if and ($conn.Zone) (not (eq $conn.Zone "NULL"))}}
              {{$conn.Zone}}
            {{else}}
              <span class="tag is-info">the firewall's default zone</span>
            {{end}}
          </div>
        </div>
      </div>
    </div>
  </turbo-frame>

  <h4>Autoconnect</h4>
  <p class="mb-3">
    Autoconnect allows this profile to be automatically selected for activation by an appropriate
    network device when that device is inactive (i.e. doesn't already have some other connection
    profile activated for it). Without autoconnect, this connection profile can only be activated
    by a manual user action.
  </p>
  <div class="field is-horizontal">
    <div class="field-label">
      <label class="label">
        <abbr title="whether to automatically activate the profile when circumstances are suitable">
          Enabled?
        </abbr>
      </label>
    </div>
    <div class="field-body">
      <div class="field">
        <div class="control">
          <input type="hidden" name="connection.autoconnect" value="off">
          <input type="checkbox"
            name="connection.autoconnect"
            value="on"
            autocomplete="off"
            {{if $conn.Autoconnect}}checked{{end}}
          />
        </div>
      </div>
    </div>
  </div>

  <div class="field is-horizontal">
    <div class="field-label is-normal">
      <label class="label">
        <abbr title="higher-priority profiles are preferred; when two profiles have equal priority, the most-recently used profile is chosen">
          Priority
        </abbr>
      </label>
    </div>
    <div class="field-body">
      <div class="field">
        <div class="control">
          <input
            class="input" type="number"
            name="connection.autoconnect-priority"
            min="-999" max="999"
            value="{{$conn.AutoconnectPriority}}"
          >
        </div>
      </div>
    </div>
  </div>

  <div class="field is-horizontal">
    <div class="field-label">
      <label class="label">
        <abbr title="total number of times to try autoconnecting before giving up and possibly allowing another connection profile to be used instead">
          Retries
        </abbr>
      </label>
    </div>
    <div class="field-body">
      <div class="field">
        <div class="control">
          {{if eq $conn.AutoconnectRetries -1}}
            <span class="tag is-info"><abbr title="if not set, defaults to 4 times">global default</abbr></span>
          {{else if eq $conn.AutoconnectRetries 0}}
            <span class="tag is-info">indefinitely</span>
          {{else}}
            <span class="tag is-info">{{$conn.AutoconnectRetries}}</span>
          {{end}}
        </div>
      </div>
    </div>
  </div>

  {{if eq $conn.Type "802-11-wireless"}}
    <h3>Wi-Fi</h3>
    {{$wifi := $settings.Wifi}}
    <div class="field is-horizontal">
      <div class="field-label is-normal">
        <label class="label">
          <abbr title="Wi-Fi network mode">
            Mode
          </abbr>
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            <div class="select">
              <select name="802-11-wireless.mode">
                <option
                  value="infrastructure"
                  {{if eq $wifi.Mode.Info.Short "infrastructure"}}selected{{end}}
                >
                  infrastructure (connect to external network)
                </option>
                <option
                  value="ap"
                  {{if eq $wifi.Mode.Info.Short "ap"}}selected{{end}}
                >
                  hotspot
                </option>
                <option
                  value="mesh"
                  {{if eq $wifi.Mode.Info.Short "mesh"}}selected{{end}}
                >
                  mesh (802.11s)
                </option>
                <option
                  value="adhoc"
                  {{if eq $wifi.Mode.Info.Short "adhoc"}}selected{{end}}
                >
                  ad-hoc (IBSS)
                </option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="field is-horizontal">
      <div class="field-label is-normal">
        <label class="label">
          <abbr title="Wi-Fi network name">
            SSID
          </abbr>
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            <input
              class="input" type="text"
              name="802-11-wireless.ssid"
              minlength=1 maxlength=32
              value="{{toString $wifi.SSID}}"
              size=40
              required
            >
          </div>
        </div>
      </div>
    </div>

    <div class="field is-horizontal">
      <div class="field-label">
        <label class="label">
          <abbr title="whether the network hides its SSID">
            Hidden?
          </abbr>
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            <input type="hidden" name="802-11-wireless.hidden" value="false">
            <input type="checkbox"
              name="802-11-wireless.hidden"
              value="true"
              autocomplete="off"
              {{if $wifi.Hidden}}checked{{end}}
            />
          </div>
        </div>
      </div>
    </div>

    <div class="field is-horizontal">
      <div class="field-label is-normal">
        <label class="label">
          <abbr title="802.11 frequency band of the network">
            Band
          </abbr>
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            <div class="select">
              <select name="802-11-wireless.band">
                <option
                  value="a"
                  {{if eq $wifi.Band "a"}}selected{{end}}
                >
                  802.11a (5 GHz)
                </option>
                <option
                  value="bg"
                  {{if eq $wifi.Band "bg"}}selected{{end}}
                >
                  802.11b/g (2.4 GHz)
                </option>
                <option
                  value=""
                  {{if eq $wifi.Band ""}}selected{{end}}
                >
                  any available band
                </option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="field is-horizontal">
      <div class="field-label is-normal">
        <label class="label">
          <abbr title="wireless channel to require, if non-zero; a non-zero value requires Band to be set to a specific frequency band">
            Channel
          </abbr>
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            <input
              class="input" type="number"
              name="802-11-wireless.channel"
              min="0" max="256"
              value="{{$wifi.Channel}}"
            >
          </div>
        </div>
      </div>
    </div>

    <h4>Security</h4>
    {{$wifiSec := $settings.WifiSec}}
    <div class="field is-horizontal">
      <div class="field-label is-normal">
        <label class="label">
          <abbr title="key-management mode">
            Mode
          </abbr>
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            <div class="select">
              <select name="802-11-wireless-security.key-mgmt">
                <option
                  value=""
                  {{if eq $wifiSec.KeyMgmt ""}}selected{{end}}
                >
                  None
                </option>
                <option
                  value="wpa-psk"
                  {{if eq $wifiSec.KeyMgmt "wpa-psk"}}selected{{end}}
                >
                  WPA2/3-Personal Pre-Shared Key (PSK)
                </option>
                <option
                  value="wpa-eap"
                  {{if eq $wifiSec.KeyMgmt "wpa-eap"}}selected{{end}}
                >
                  WPA2/3-Enterprise <abbr title="Extensible Authentication Protocol">EAP</abbr>
                </option>
                <option
                  value="sae"
                  {{if eq $wifiSec.KeyMgmt "sae"}}selected{{end}}
                >
                  WPA3-Personal <abbr title="Simultaneous Authentication of Equals">SAE</abbr>
                </option>
                <option
                  value="wpa-eap-suite-b-192"
                  {{if eq $wifiSec.KeyMgmt "wpa-eap-suite-b-192"}}selected{{end}}
                >
                  WPA3-Enterprise <abbr title="Extensible Authentication Protocol">EAP</abbr>
                  with SuiteB-<abbr title="192-bit encryption">192</abbr>
                </option>
                <option
                  value="owe"
                  {{if eq $wifiSec.KeyMgmt "owe"}}selected{{end}}
                >
                  OWE
                </option>
                <option
                  value="none"
                  {{if eq $wifiSec.KeyMgmt "none"}}selected{{end}}
                >
                  WEP (insecure)
                </option>
                <option
                  value="ieee8021x"
                  {{if eq $wifiSec.KeyMgmt "ieee8021x"}}selected{{end}}
                >
                  <abbr title="IEEE 802.1x">Dynamic WEP</abbr> (insecure)
                </option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="field is-horizontal">
      <div class="field-label is-normal">
        <label class="label">
          <abbr title="Wi-Fi security passphrase; not needed if mode is None or OWE">
            Password
          </abbr>
        </label>
      </div>
      <div class="field-body">
        <div
          class="field"
          data-controller="password-input"
          data-password-input-target="addons"
        >
          <div class="control">
            <input
              class="input" type="password"
              name="802-11-wireless-security.psk"
              minlength=1
              placeholder="not shown here, for security reasons"
              size=30
              data-password-input-target="input"
              data-checkable-textbox-target="textbox"
              data-action="input->password-input#edit"
            >
          </div>
          <div class="control">
            <button
              class="button is-hidden"
              data-password-input-target="toggler"
              data-action="click->password-input#toggle:prevent"
            >
              <span class="icon">
                <img class="mdi mdi-inactive"
                  src="{{$Meta.BasePath}}{{staticHashed "icons/eye-outline.svg"}}"
                  width="20" height="20"
                  alt="Toggle password visibility"
                >
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="field is-horizontal">
      <div class="field-label">
        <label class="label">
          <abbr title="allowed WPA protocol versions; selecting none is equivalent to selecting all">
            Protocols
          </abbr>
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            <div class="checkboxes">
              {{$wifiSecPairwise := $wifiSec.Proto.Strings}}
              <input type="hidden" name="802-11-wireless-security.proto" value="">
              <label class="checkbox is-block">
                <input
                  type="checkbox"
                  name="802-11-wireless-security.proto"
                  value="rsn"
                  autocomplete="off"
                  {{if or (not $wifiSec.Proto) (has "rsn" $wifiSecPairwise)}}checked{{end}}
                />
                WPA2/3 <abbr title="Robust Security Network">RSN</abbr>
              </label>
              <label class="checkbox is-block">
                <input
                  type="checkbox"
                  name="802-11-wireless-security.proto"
                  value="wpa"
                  autocomplete="off"
                  {{if or (not $wifiSec.Proto) (has "wpa" $wifiSecPairwise)}}checked{{end}}
                />
                WPA (insecure)
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="field is-horizontal">
      <div class="field-label">
        <label class="label">
          <abbr title="allowed pairwise encryption algorithms; selecting none is equivalent to selecting all">
            Pairwise
          </abbr>
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            <div class="checkboxes">
              {{$wifiSecPairwise := $wifiSec.Pairwise.Strings}}
              <input type="hidden" name="802-11-wireless-security.pairwise" value="">
              <label class="checkbox is-block">
                <input
                  type="checkbox"
                  name="802-11-wireless-security.pairwise"
                  value="ccmp"
                  autocomplete="off"
                  {{if or (not $wifiSec.Pairwise) (has "ccmp" $wifiSecPairwise)}}checked{{end}}
                />
                AES/CCMP (WPA2/3)
              </label>
              <label class="checkbox is-block">
                <input
                  type="checkbox"
                  name="802-11-wireless-security.pairwise"
                  value="tkip"
                  autocomplete="off"
                  {{if or (not $wifiSec.Pairwise) (has "tkip" $wifiSecPairwise)}}checked{{end}}
                />
                TKIP (WPA, insecure)
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="field is-horizontal">
      <div class="field-label">
        <label class="label">
          <abbr title="allowed group/broadcast encryption algorithms; selecting none is equivalent to selecting all">
            Group
          </abbr>
        </label>
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            <div class="checkboxes">
              {{$wifiSecGroup := $wifiSec.Group.Strings}}
              <input type="hidden" name="802-11-wireless-security.group" value="">
              <label class="checkbox is-block">
                <input
                  type="checkbox"
                  name="802-11-wireless-security.group"
                  value="ccmp"
                  autocomplete="off"
                  {{if or (not $wifiSec.Group) (has "ccmp" $wifiSecGroup)}}checked{{end}}
                />
                AES/CCMP (WPA2/3)
              </label>
              <label class="checkbox is-block">
                <input
                  type="checkbox"
                  name="802-11-wireless-security.group"
                  value="tkip"
                  autocomplete="off"
                  {{if or (not $wifiSec.Group) (has "tkip" $wifiSecGroup)}}checked{{end}}
                />
                TKIP (WPA, insecure)
              </label>
              <label class="checkbox is-block">
                <input
                  type="checkbox"
                  name="802-11-wireless-security.group"
                  value="wep104"
                  autocomplete="off"
                  {{if or (not $wifiSec.Group) (has "wep104" $wifiSecGroup)}}checked{{end}}
                />
                WEP-<abbr title="104-bit key">104</abbr> (insecure)
              </label>
              <label class="checkbox is-block">
                <input
                  type="checkbox"
                  name="802-11-wireless-security.group"
                  value="wep40"
                  autocomplete="off"
                  {{if or (not $wifiSec.Group) (has "wep40" $wifiSecGroup)}}checked{{end}}
                />
                WEP-<abbr title="40-bit key">40</abbr> (insecure)
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  {{end}}

  <h3>IPv4</h3>
  {{$ipv4 := $settings.IPv4}}
  <div class="field is-horizontal">
    <div class="field-label">
      <label class="label">Addresses</label>
    </div>
    <div class="field-body">
      <div class="field">
        <div class="control">
          <ul class="mt-0">
            {{range $ipAddress := $ipv4.Addresses}}
              <li>
                <p><span class="tag ip-address">{{$ipAddress.Prefix.Addr}}</span></p>
                {{if not $ipAddress.Prefix.IsSingleIP}}
                  <p>
                    <abbrev title="space of addresses assignable to devices on the network">Subnet</abbrev>:
                    <span class="tag ip-subnet">{{$ipAddress.Prefix.Masked}}</span>
                  </p>
                {{end}}
                {{range $key, $value := $ipAddress.Attributes}}
                  <p>
                    {{title $key}}:
                    {{if isIPAddr $value}}
                      <span class="tag ip-address">{{$value}}</span>
                    {{else}}
                      {{$value}}
                    {{end}}
                  </p>
                {{end}}
              </li>
            {{else}}
              <li><span class="tag is-abbrev">none</span></li>
            {{end}}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <h3>IPv6</h3>
  {{$ipv6 := $settings.IPv6}}
  <div class="field is-horizontal">
    <div class="field-label">
      <label class="label">Addresses</label>
    </div>
    <div class="field-body">
      <div class="field">
        <div class="control">
          <ul class="mt-0">
            {{range $ipAddress := $ipv6.Addresses}}
              <li>
                <p><span class="tag ip-address">{{$ipAddress.Prefix.Addr}}</span></p>
                {{if not $ipAddress.Prefix.IsSingleIP}}
                  <p>
                    <abbrev title="space of addresses assignable to devices on the network">Subnet</abbrev>:
                    <span class="tag ip-subnet">{{$ipAddress.Prefix.Masked}}</span>
                  </p>
                {{end}}
                {{range $key, $value := $ipAddress.Attributes}}
                  <p>
                    {{title $key}}:
                    {{if isIPAddr $value}}
                      <span class="tag ip-address">{{$value}}</span>
                    {{else}}
                      {{$value}}
                    {{end}}
                  </p>
                {{end}}
              </li>
            {{else}}
              <li><span class="tag is-abbrev">none</span></li>
            {{end}}
          </ul>
        </div>
      </div>
    </div>
  </div>
</form>
