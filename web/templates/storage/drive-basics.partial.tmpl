{{$drive := (get . "Drive")}}
{{$blockDevices := (get . "BlockDevices")}}
{{$isSystem := (get . "IsSystem")}}
{{$diskUsages := (get . "DiskUsages")}}
{{$Meta := (get . "Meta")}}

{{$hasMounts := false}}
{{range $device := $blockDevices}}
  {{if gt (len $device.Filesystem.MountPoints) 0}}
    {{$hasMounts = true}}
  {{end}}
{{end}}

<turbo-frame
  id="storage_drives_{{$drive.ID}}_basics.frame"
  data-turbo-reload
>
  {{if $hasMounts}}
    <ul class="mt-0 mb-3">
      {{range $device := $blockDevices}}
        {{$mountPoints := $device.Filesystem.MountPoints}}
        {{range $mountPoint := $mountPoints}}
          {{$diskUsage := index $diskUsages $mountPoint}}
          {{if not $diskUsage.Size}}
            {{continue}}
          {{end}}

          <li>
            <p>
              {{if gt (len $mountPoints) 1}}
                <abbr title="{{$mountPoints | join ", "}}">
                  {{$mountPoint}}
                </abbr>
              {{else}}
                {{$mountPoint}}
              {{end}}
            </p>
            {{template "storage/disk-usage.partial.tmpl" (index $diskUsages $mountPoint)}}
          </li>
          {{break}}
        {{end}}
      {{end}}
    </ul>
  {{end}}

  {{if not $isSystem}}
    {{if $hasMounts}}
      <article class="message is-warning mt-5 mb-3">
        <div class="message-body">
          This drive is mounted at the paths listed above. To avoid data corruption, you should
          <em>safely remove</em> (i.e. unmount) it before you unplug it from the machine:
        </div>
      </article>

      <form
        action="{{$Meta.BasePath}}storage/drives/{{$drive.ID}}"
        method="POST"
        data-controller="form-submission"
        data-action="submit->form-submission#submit"
        class="is-inline-block"
      >
        <input type="hidden" name="state" value="unmounted">
        <input type="hidden" name="redirect-target" value="{{urlJoin (dict
          "path" $Meta.Path
          "query" $Meta.Form.Encode
        )}}">
        <div class="field">
          <div class="control" data-form-submission-target="submitter">
            <input
              class="button is-info"
              type="submit"
              value="Safely remove drive"
              data-form-submission-target="submit"
            >
          </div>
        </div>
      </form>
    {{else if not $isSystem}}
      <article class="message is-success">
        <div class="message-body">
          This drive is safe to unplug now.
        </div>
      </article>
    {{end}}
  {{end}}
</turbo-frame>
